<%_ menus = {
    branding: {
        type: 'brand',
        title: apptitle,
        logo: path('/images/logo.png'),
        url: path('/')
    },
    tasks: {
        title: _('Tasks'),
        class: 'right floated',
        items: {
            about: {
                title: _('About')
            }
        }
    }
} -%>
<%_ if (user.authenticated) {
    Object.assign(menus.tasks.items, {
        divider1: {
            type: 'divider'
        },
        restart: {
            title: _('Restart Server'),
        },
        divider2: {
            type: 'divider'
        },
        logout: {
            title: _('Logout'),
            url: route('Security', {name: 'logout'})
        }
    });
} -%>
<%- menu(menus, {mainmenu: true}) %>
<%_ script.create('JQuery')
  .useDependencies(['JQuery/Util', 'SemanticUI/Notification', 'SemanticUI/Dialog/Message', 'SemanticUI/Dialog/Confirm'])
  .add(`
$.tasks = {
    about() {
        const self = this;
        const f = function() {
            const msg = $.util.template(
                '<p>%TITLE%<br/>\\n' +
                'Version %VERSION%<br/>\\n' +
                '&copy; %AUTHOR%<br/>\\n' +
                'Licensed under %LICENSE%</p>', {
                    TITLE: self.aboutInfo.title,
                    VERSION: self.aboutInfo.version,
                    AUTHOR: $('<div>').text(self.aboutInfo.author).html(),
                    LICENSE: self.aboutInfo.license
                }
            );
            $.ntdlg.message('task-about', '${_('About')}', msg, $.ntdlg.ICON_INFO);
        }
        if (!self.aboutInfo) {
            $.get('${route('Ui', {name: 'about'})}')
                .done(function(json) {
                    self.aboutInfo = json;
                    f();
                });
        } else {
            f();
        }
    },
    restart() {
        const self = this;
        if (self._restart === undefined) {
            self._restart = true;
            $.ntdlg.confirm(
                'restart-confirm-dlg',
                '${_('Confirm')}',
                '${_('Are you sure want to restart the server?')}',
                $.ntdlg.ICON_QUESTION,
                function() {
                    $.post('${route('Ui', {name: 'task', op: 'restart'})}')
                        .done(function(json) {
                            self.notify(json);
                        })
                        .always(function() {
                            delete self._restart;
                        });
                },
                function() {
                    delete self._restart;
                }
            );
        }
    },
    notify(result) {
        if (result.success) {
            $.notify('${_('Operation successfully submitted!')}', 'success');
        } else {
            $.notify('${_('Operation failed!')}', 'error');
        }
    },
    init() {
        const self = this;
        $('.menu div.item').on('click', function(e) {
            e.preventDefault();
            const menu = $(this).attr('class').split(' ')[0].split('-')[1];
            if (typeof self[menu] === 'function') {
                self[menu]();
            }
        });
    }
}
`).addInitializer(`
$.tasks.init();
`) -%>